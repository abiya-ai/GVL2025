# Corrected cloudbuild.yaml
options:
  logging: CLOUD_LOGGING_ONLY
steps:
# 1. Build the Docker Image 
- name: 'gcr.io/cloud-builders/docker'
  id: Build
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/gvl2025-workshop:$SHORT_SHA', '.'] 

# 2. Push the Docker Image 
- name: 'gcr.io/cloud-builders/docker'
  id: Push
  args: ['push', 'gcr.io/$PROJECT_ID/gvl2025-workshop:$SHORT_SHA'] 

# 3. Deploy the new version to Cloud Run
- name: 'gcr.io/cloud-builders/gcloud'
  id: Deploy
  args:
  - 'run'
  - 'deploy'
  - 'gvl-webapp'
  - '--image=gcr.io/$PROJECT_ID/gvl2025-workshop:$SHORT_SHA' # <-- This path is now consistent
  - '--region=us-central1'
  - '--no-allow-unauthenticated'